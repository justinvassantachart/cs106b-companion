<app-sidebar [files]="files" [selectedFile]="selectedFile" (selectFile)="selectFile($event)" [currentUser]="currentUser"
  [isSyncing]="isSyncing" (login)="login()" (logout)="logout()">


  <!-- Main Layout: Vertical Split -->
  <div
    class="flex flex-col h-full w-full bg-background text-foreground font-sans selection:bg-primary/30 overflow-hidden">

    <!-- TOP PANEL: Toolbar + Editor (Flex 1) -->
    <div class="flex-1 flex flex-col min-h-0 border-b border-border">

      <!-- Toolbar -->
      <header class="h-12 border-b border-border bg-card flex items-center justify-between px-4 shrink-0">
        <div class="flex items-center gap-4">
          <button hlmSidebarTrigger class="text-muted-foreground hover:text-foreground transition-colors">
            <lucide-icon [img]="icons.Terminal" class="w-5 h-5"></lucide-icon>
          </button>
          <div class="flex items-center gap-2">
            <lucide-icon [img]="icons.FileCode" class="w-4 h-4 text-muted-foreground"></lucide-icon>
            <span class="text-sm font-medium text-foreground">
              {{ selectedFile ? selectedFile.title + '.cpp' : 'No file selected' }}
            </span>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button (click)="startDebugger()" [disabled]="isDebugging || !selectedFile" [hlmTooltipTrigger]="'Run'"
            class="flex items-center gap-2 px-3 py-1.5 bg-primary hover:bg-primary/90 text-primary-foreground rounded-md text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm min-w-[80px] justify-center active:scale-95 disabled:active:scale-100">
            <ng-container *ngIf="!isCompiling">
              <lucide-icon [img]="icons.Play" class="w-4 h-4 fill-current"></lucide-icon>
              Run
            </ng-container>
            <ng-container *ngIf="isCompiling">
              <lucide-icon [img]="icons.Loader2" class="w-4 h-4 animate-spin"></lucide-icon>
              Compiling...
            </ng-container>
          </button>

          <div class="h-6 w-px bg-border mx-2"></div>

          <!-- Step Back -->
          <button (click)="stepBack()"
            [disabled]="history.length === 0 || (historyIndex !== -1 && historyIndex === 0) || !selectedFile"
            [hlmTooltipTrigger]="'Step Back'"
            class="p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md disabled:opacity-30 disabled:hover:bg-transparent transition-all active:scale-95 disabled:active:scale-100">
            <lucide-icon [img]="icons.StepBack" class="w-4 h-4"></lucide-icon>
          </button>

          <!-- Step Forward -->
          <button (click)="stepForward()"
            [disabled]="((historyIndex === -1 && !isPaused) || (history.length === 0 && !isPaused)) || !selectedFile"
            [hlmTooltipTrigger]="historyIndex === -1 ? 'Execute Next Line' : 'Step Forward'"
            class="p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md disabled:opacity-30 disabled:hover:bg-transparent transition-all active:scale-95 disabled:active:scale-100">
            <lucide-icon [img]="icons.ArrowRight" class="w-4 h-4"></lucide-icon>
          </button>

          <div class="h-6 w-px bg-border mx-2"></div>

          <button (click)="runAll()" [disabled]="!isDebugging || !selectedFile" [hlmTooltipTrigger]="'Continue to End'"
            class="p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md disabled:opacity-30 disabled:hover:bg-transparent transition-all active:scale-95 disabled:active:scale-100">
            <lucide-icon [img]="icons.FastForward" class="w-4 h-4"></lucide-icon>
          </button>

          <button (click)="pause()" [disabled]="(!isDebugging || isPaused) || !selectedFile"
            [hlmTooltipTrigger]="'Pause'"
            class="p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md disabled:opacity-30 disabled:hover:bg-transparent transition-all active:scale-95 disabled:active:scale-100">
            <lucide-icon [img]="icons.Pause" class="w-4 h-4"></lucide-icon>
          </button>

          <button (click)="stop()" [disabled]="!isDebugging || !selectedFile" [hlmTooltipTrigger]="'Stop'"
            class="p-1.5 text-destructive hover:text-destructive hover:bg-destructive/10 rounded-md disabled:opacity-30 transition-all active:scale-95 disabled:active:scale-100">
            <lucide-icon [img]="icons.Square" class="w-4 h-4 fill-current"></lucide-icon>
          </button>
        </div>
      </header>

      <!-- Editor Area (Switches between Welcome and Editor) -->
      <div class="flex-1 relative overflow-hidden bg-background">

        <!-- WELCOME SCREEN (Condition: !selectedFile) -->
        <div *ngIf="!selectedFile"
          class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-background via-background to-muted/20">
          <!-- Icon Container -->
          <div class="relative mb-8">
            <div class="absolute inset-0 bg-primary/20 rounded-full blur-2xl scale-150 animate-pulse"></div>
            <div class="relative p-6 bg-card border border-border rounded-2xl shadow-lg">
              <lucide-icon [img]="icons.FileCode" class="w-16 h-16 text-primary"></lucide-icon>
            </div>
          </div>

          <!-- Welcome Text -->
          <h2 class="text-3xl font-bold text-foreground mb-3 tracking-tight">CS106B Unofficial IDE</h2>
          <p class="text-lg text-muted-foreground mb-2 max-w-md text-center">
            Debug code, visualize data structures in the stack and heap, trace back and forth in code, and more.
          </p>
          <p class="text-sm text-muted-foreground/70 mb-8 max-w-md text-center">
            Select a file from the sidebar to get started
          </p>

          <!-- Quick Actions -->
          <div class="flex flex-col items-center gap-4 mt-6">
            <!-- Sign In Hint -->
            <div
              class="flex items-center gap-2 text-sm text-muted-foreground bg-muted/50 px-4 py-2 rounded-full border border-border/50">
              <lucide-icon [img]="icons.LogIn" class="w-4 h-4 text-primary"></lucide-icon>
              <span>Tip: Sign in to save your code and progress.</span>
            </div>
          </div>

          <!-- Decorative Elements -->
          <div class="absolute bottom-8 left-8 w-32 h-32 bg-primary/5 rounded-full blur-3xl"></div>
          <div class="absolute top-16 right-16 w-24 h-24 bg-primary/5 rounded-full blur-2xl"></div>
        </div>

        <!-- EDITOR & LOADING (Condition: selectedFile) -->
        <ng-container *ngIf="selectedFile">
          <div *ngIf="isLoading"
            class="absolute inset-0 z-50 flex items-center justify-center bg-background/50 backdrop-blur-[1px]">
            <div class="flex flex-col items-center gap-3">
              <lucide-icon [img]="icons.Loader2" class="w-8 h-8 animate-spin text-primary"></lucide-icon>
              <span class="text-sm font-medium text-muted-foreground">Loading...</span>
            </div>
          </div>
          <app-monaco-editor [code]="studentCode" (codeChange)="handleCodeChange($event)" [breakpoints]="breakpoints"
            (breakpointToggle)="toggleBreakpoint($event)" [theme]="isDark ? 'vs-dark' : 'vs-light'"
            class="w-full h-full block">
          </app-monaco-editor>
        </ng-container>
      </div>
    </div>

    <!-- Horizontal Sash (VS Code-style resize handle) - Only show if file selected -->
    <app-sash *ngIf="selectedFile" class="sash-container-horizontal" orientation="horizontal"
      (sashStart)="onBottomSashStart()" (sashChange)="onBottomSashChange($event)"></app-sash>

    <!-- BOTTOM PANEL: Debugger Tools (Dynamic Height) - Only show if file selected -->
    <div *ngIf="selectedFile"
      class="flex flex-col shrink-0 bg-card border-t border-border shadow-[0_-4px_12px_rgba(0,0,0,0.1)] z-10"
      [style.height.px]="bottomPanelHeight">

      <!-- Tabs Header -->
      <div class="flex items-center border-b border-border px-4 bg-muted/50">
        <button
          class="px-4 py-2 text-xs font-bold uppercase tracking-wider border-b-[2px] transition-colors focus:outline-none"
          [class.border-primary]="activeTab === 'console'" [class.text-primary]="activeTab === 'console'"
          [class.text-muted-foreground]="activeTab !== 'console'" [class.border-transparent]="activeTab !== 'console'"
          (click)="activeTab = 'console'">Console Output</button>

        <button
          class="px-4 py-2 text-xs font-bold uppercase tracking-wider border-b-[2px] transition-colors focus:outline-none flex items-center gap-2"
          [class.border-primary]="activeTab === 'tests'" [class.text-primary]="activeTab === 'tests'"
          [class.text-muted-foreground]="activeTab !== 'tests'" [class.border-transparent]="activeTab !== 'tests'"
          (click)="activeTab = 'tests'">
          Test Results
          <div *ngIf="testResults.length"
            class="ml-0.5 px-1.5 py-0.5 rounded-full bg-muted text-[10px] text-foreground font-mono">
            {{testResults.length}}</div>
        </button>

        <button *ngIf="isDebugging"
          class="px-4 py-2 text-xs font-bold uppercase tracking-wider border-b-[2px] transition-colors focus:outline-none flex items-center gap-2"
          [class.border-primary]="activeTab === 'variables'" [class.text-primary]="activeTab === 'variables'"
          [class.text-muted-foreground]="activeTab !== 'variables'"
          [class.border-transparent]="activeTab !== 'variables'" (click)="activeTab = 'variables'">
          Variables & Memory
        </button>
      </div>

      <!-- Tab Content Areas -->
      <div class="flex-1 min-h-0 overflow-hidden relative bg-card">

        <!-- Console -->
        <div class="w-full h-full overflow-auto p-4 font-mono text-xs leading-relaxed custom-scrollbar"
          *ngIf="activeTab === 'console'">
          <pre *ngIf="outputLogs" class="text-foreground whitespace-pre-wrap break-words"
            [innerHTML]="processedOutputHtml"></pre>
          <div *ngIf="!outputLogs" class="text-muted-foreground italic select-none">Ready to run... <br>Click Run to
            start.
          </div>

          <div *ngIf="isDebugging && !isPaused"
            class="fixed bottom-4 right-4 flex gap-2 items-center bg-popover/80 p-2 rounded-md text-popover-foreground shadow backdrop-blur border border-border">
            <span class="w-2 h-2 rounded-full bg-primary animate-pulse"></span>
            <span class="text-xs">Running...</span>
          </div>
        </div>

        <!-- Tests -->
        <div class="w-full h-full overflow-auto p-4 custom-scrollbar" *ngIf="activeTab === 'tests'">
          <div *ngFor="let result of testResults" class="mb-2 p-3 rounded-md bg-card border transition-all"
            [class.border-green-500/30]="result.pass" [class.bg-green-500/5]="result.pass"
            [class.border-destructive/30]="!result.pass" [class.bg-destructive/5]="!result.pass">
            <div class="flex items-start gap-3">
              <lucide-icon [img]="result.pass ? icons.CheckCircle : icons.XCircle" [class.text-green-500]="result.pass"
                [class.text-destructive]="!result.pass" class="w-5 h-5 mt-0.5 shrink-0"></lucide-icon>
              <div class="min-w-0 flex-1">
                <div class="font-medium text-sm text-foreground font-mono break-all">{{ result.expression }}</div>
                <div *ngIf="!result.pass"
                  class="text-xs text-destructive mt-2 font-mono bg-destructive/10 p-2 rounded-md border border-destructive/20">
                  <div class="flex gap-2"><span class="opacity-70 w-16 px-1">Expected:</span> <span
                      class="text-destructive">{{ result.expected }}</span></div>
                  <div class="flex gap-2"><span class="opacity-70 w-16 px-1">Actual:</span> <span
                      class="text-destructive">{{ result.actual }}</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Variables (Full Width) -->
        <div class="w-full h-full flex flex-row" *ngIf="activeTab === 'variables'">
          <!-- Call Stack Sidebar (retained inside visualizer view effectively) -->
          <div class="bg-muted/20 border-r border-border flex flex-col shrink-0" [style.width.px]="callStackWidth">
            <div
              class="px-3 py-2 bg-muted/50 border-b border-border text-xs font-semibold text-muted-foreground uppercase tracking-wider">
              Call Stack
            </div>
            <div class="flex-1 overflow-y-auto">
              <div *ngFor="let frame of debugStack.slice().reverse(); let i = index"
                class="px-3 py-2 text-sm border-b border-border/50 flex items-center gap-2"
                [class.bg-primary/10]="i === 0" [class.text-primary]="i === 0" [class.text-muted-foreground]="i !== 0">
                <div *ngIf="i === 0" class="w-1.5 h-1.5 rounded-full bg-primary"></div>
                <div *ngIf="i !== 0" class="w-1.5 h-1.5"></div>
                <span class="font-mono truncate">{{ frame }}</span>
              </div>
            </div>
          </div>

          <!-- Vertical Sash (VS Code-style resize handle) -->
          <app-sash class="sash-container-vertical" orientation="vertical" (sashStart)="onCallStackSashStart()"
            (sashChange)="onCallStackSashChange($event)"></app-sash>

          <!-- Main Visualizer -->
          <app-variable-viz [variables]="debugVars" class="flex-1 min-h-0 bg-background"></app-variable-viz>
        </div>

      </div>

    </div>
  </div>

</app-sidebar>